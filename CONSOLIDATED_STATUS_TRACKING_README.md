# Consolidated Status Tracking Solution

## Overview

This solution consolidates the status tracking functionality for both **Orders** and **Deliveries** using a unified `StatusHistory` table, eliminating the redundancy between `OrderStatusHistory` and the previously planned `DeliveryStatusTracker` table.

## Problem Addressed

The original implementation had two separate tables for tracking status changes:

- `OrderStatusHistory` - for tracking order status changes
- `DeliveryStatusTracker` - for tracking delivery status changes (planned)

This created redundancy and potential maintenance issues. The new solution uses a single, flexible table that can handle status tracking for any entity type.

## New Database Schema

### StatusHistory Table (Consolidated)

```sql
CREATE TABLE "StatusHistory" (
  "status_history_id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "entity_type" varchar NOT NULL, -- 'order' or 'delivery'
  "entity_id" int NOT NULL,
  "status" varchar NOT NULL,
  "updated_at" timestamp DEFAULT (now()),
  "updated_by" int,
  "notes" text
);
```

### WarehouseProductRequest Table (Delivery-specific)

```sql
CREATE TABLE "WarehouseProductRequest" (
  "request_id" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  "delivery_id" int NOT NULL,
  "requesting_warehouse_id" int NOT NULL,
  "target_warehouse_id" int NOT NULL,
  "product_id" int NOT NULL,
  "requested_quantity" int NOT NULL,
  "status" varchar DEFAULT 'pending',
  "requested_at" timestamp DEFAULT (now()),
  "fulfilled_at" timestamp,
  "notes" text
);
```

### Enhanced Tables

- `Order` table: Added `current_status` column
- `Delivery` table: Added `current_status` column

## New Backend Components

### Controllers

1. **`statusTrackingUtility.js`** - Consolidated utility for managing status updates
2. **`enhancedDeliveryController.js`** - Multi-step delivery process management
3. **`warehouseInventoryController.js`** - Warehouse inventory and product availability

### Routes

1. **`statusTrackingRoute.js`** - Unified status tracking endpoints
2. **`enhancedDeliveryRoute.js`** - Enhanced delivery workflow endpoints
3. **`warehouseInventoryRoute.js`** - Warehouse inventory management endpoints

## API Endpoints

### Status Tracking

- `GET /api/status/order/:orderId/history` - Get order status history
- `GET /api/status/delivery/:deliveryId/history` - Get delivery status history
- `GET /api/status/:entityType/:entityId/current-status` - Get current status
- `POST /api/status/migrate-order-status` - Migration endpoint

### Enhanced Delivery Process

- `GET /api/delivery/enhanced/:delivery_boy_id` - Get enhanced assigned deliveries
- `PUT /api/delivery/:deliveryId/start-fetching` - Start product fetching
- `PUT /api/delivery/:deliveryId/mark-fetched` - Mark products as fetched
- `PUT /api/delivery/:deliveryId/start-delivery` - Start delivery to customer
- `POST /api/delivery/:deliveryId/request-product` - Request product from warehouse

### Warehouse Inventory

- `GET /api/warehouse/warehouse/:warehouseId/inventory` - Get warehouse inventory
- `GET /api/warehouse/delivery-boy/:deliveryBoyId/warehouse` - Get delivery boy's warehouse
- `GET /api/warehouse/delivery/:deliveryId/check-availability` - Check product availability

## Delivery Status Flow

1. **assigned** → Initial status when delivery is assigned
2. **fetching_products** → Delivery boy starts fetching products from warehouse
3. **products_fetched** → All products have been collected
4. **in_transit** → Delivery is on the way to customer
5. **delivered** → Delivery completed successfully

## Migration Process

1. **Run the migration script**: `migration_consolidated_status.sql`
2. **Verify data migration**: Check that OrderStatusHistory data is moved to StatusHistory
3. **Update applications**: Ensure all code uses the new StatusHistory approach
4. **Drop old tables**: After verification, optionally drop OrderStatusHistory

## Frontend Integration

The frontend components have been updated to work with the new consolidated approach:

- **`AssignedDeliveries.jsx`** - Multi-step delivery process UI
- **`WarehouseInventory.jsx`** - Warehouse inventory management UI
- **`DeliveryBoy.jsx`** - Updated delivery boy dashboard

## Key Benefits

1. **Eliminated Redundancy**: Single table for all status tracking
2. **Better Maintainability**: Unified approach for status management
3. **Enhanced Flexibility**: Easy to extend for other entity types
4. **Improved Performance**: Optimized indexing and queries
5. **Consistent API**: Unified endpoints for status operations

## Usage Examples

### Update Order Status

```javascript
import { updateOrderStatus } from "./controllers/statusTrackingUtility.js";

await updateOrderStatus(orderId, "processing", userId, "Order confirmed");
```

### Update Delivery Status

```javascript
import { updateDeliveryStatus } from "./controllers/statusTrackingUtility.js";

await updateDeliveryStatus(
  deliveryId,
  "in_transit",
  deliveryBoyId,
  "Started delivery"
);
```

### Get Status History

```javascript
import { getStatusHistory } from "./controllers/statusTrackingUtility.js";

const orderHistory = await getStatusHistory("order", orderId);
const deliveryHistory = await getStatusHistory("delivery", deliveryId);
```

## Files Modified/Created

### Backend

- `backend/controllers/statusTrackingUtility.js` (New)
- `backend/controllers/enhancedDeliveryController.js` (Updated)
- `backend/controllers/warehouseInventoryController.js` (Updated)
- `backend/routes/statusTrackingRoute.js` (New)
- `backend/routes/enhancedDeliveryRoute.js` (Updated)
- `backend/routes/warehouseInventoryRoute.js` (Updated)
- `backend/server.js` (Updated - new routes added)

### Database Scripts

- `backend/Triggers/consolidated_status_tracking.sql` (New)
- `backend/Triggers/migration_consolidated_status.sql` (New)
- `backend/Triggers/delivery_status_enhancement.sql` (Updated)

### Frontend

- `frontend/src/components/deliveryBoy/AssignedDeliveries.jsx` (Updated)
- `frontend/src/components/deliveryBoy/WarehouseInventory.jsx` (New)
- `frontend/src/pages/DeliveryBoy.jsx` (Updated)

## Next Steps

1. **Test the migration script** on a development database
2. **Run the migration** on the production database
3. **Update any remaining code** that references OrderStatusHistory directly
4. **Monitor the system** to ensure the consolidated approach works correctly
5. **Drop the old tables** after confirming everything works as expected
